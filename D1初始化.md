# Cloudflare D1 数据库初始化配置

本文档提供 MoonTV Plus 项目在 Cloudflare D1 数据库上的完整表结构和初始化 SQL。

## 数据库迁移文件

项目使用两个迁移文件来创建数据库结构：
1. `migrations/001_initial_schema.sql` - 基础表结构
2. `migrations/002_add_music_play_records.sql` - 音乐模块扩展

> **重要提示**：请直接使用 `migrations/` 目录下的 SQL 文件进行 D1 数据库初始化，不要使用本文档中的旧版 SQL（已废弃）。

## 快速开始

### 1. 安装 wrangler CLI
```bash
npm install -g wrangler
```

### 2. 登录 Cloudflare
```bash
wrangler login
```

### 3. 创建 D1 数据库
```bash
wrangler d1 create moontv-plus-db
```

### 4. 配置 wrangler.toml
将上一步返回的 `database_id` 添加到 `wrangler.toml` 文件中。

### 5. 初始化数据库表结构
```bash
# 执行基础表结构迁移
wrangler d1 execute moontv-plus-db --file=migrations/001_initial_schema.sql --remote

# 执行音乐模块迁移
wrangler d1 execute moontv-plus-db --file=migrations/002_add_music_play_records.sql --remote
```

### 6. 验证表结构
```bash
# 查看所有表
wrangler d1 execute moontv-plus-db --command="SELECT name FROM sqlite_master WHERE type='table' ORDER BY name;" --remote

# 查看表结构（示例：查看 users 表）
wrangler d1 execute moontv-plus-db --command="PRAGMA table_info(users);" --remote
```

## 表结构说明

### 1. 用户表 (users)

```sql
CREATE TABLE IF NOT EXISTS users (
  username TEXT PRIMARY KEY,
  password_hash TEXT NOT NULL,
  role TEXT NOT NULL CHECK(role IN ('owner', 'admin', 'user')),
  banned INTEGER DEFAULT 0,
  tags TEXT, -- JSON array: ["vip", "premium"]
  oidc_sub TEXT UNIQUE,
  enabled_apis TEXT, -- JSON array: ["api1", "api2"]
  created_at INTEGER NOT NULL,
  playrecord_migrated INTEGER DEFAULT 0,
  favorite_migrated INTEGER DEFAULT 0,
  skip_migrated INTEGER DEFAULT 0,
  last_movie_request_time INTEGER,
  email TEXT,
  email_notifications INTEGER DEFAULT 1
);

-- 用户表索引
CREATE INDEX IF NOT EXISTS idx_users_role ON users(role);
CREATE INDEX IF NOT EXISTS idx_users_oidc_sub ON users(oidc_sub) WHERE oidc_sub IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_users_created_at ON users(created_at);
```

**字段说明：**
- `username`: 用户名，主键
- `password_hash`: 密码哈希值（SHA-256）
- `role`: 用户角色（owner/admin/user）
- `banned`: 是否被封禁（0=正常，1=封禁）
- `tags`: 用户标签，JSON数组格式
- `oidc_sub`: OIDC 认证的 SUB 标识符
- `enabled_apis`: 启用的 API 列表，JSON数组格式
- `created_at`: 创建时间戳（毫秒）
- `playrecord_migrated`: 播放记录是否已迁移
- `favorite_migrated`: 收藏是否已迁移
- `skip_migrated`: 跳过配置是否已迁移
- `last_movie_request_time`: 最后求片时间
- `email`: 用户邮箱
- `email_notifications`: 是否启用邮件通知

### 2. 播放记录表 (play_records)

```sql
CREATE TABLE IF NOT EXISTS play_records (
  username TEXT NOT NULL,
  key TEXT NOT NULL, -- format: "source+id" (e.g., "tmdb+12345")
  title TEXT NOT NULL,
  source_name TEXT NOT NULL,
  cover TEXT,
  year TEXT,
  episode_index INTEGER NOT NULL,
  total_episodes INTEGER NOT NULL,
  play_time INTEGER NOT NULL, -- 播放进度（秒）
  total_time INTEGER NOT NULL, -- 总时长（秒）
  save_time INTEGER NOT NULL, -- 保存时间戳
  search_title TEXT,
  PRIMARY KEY (username, key),
  FOREIGN KEY (username) REFERENCES users(username) ON DELETE CASCADE
);

-- 播放记录索引
CREATE INDEX IF NOT EXISTS idx_play_records_save_time ON play_records(username, save_time DESC);
CREATE INDEX IF NOT EXISTS idx_play_records_source ON play_records(username, source_name);
```

**字段说明：**
- `username`: 用户名，外键
- `key`: 视频唯一标识，格式为 "source+id"（如 "tmdb+12345"）
- `title`: 视频标题
- `source_name`: 来源名称
- `cover`: 封面图 URL
- `year`: 发行年份
- `episode_index`: 当前播放集数
- `total_episodes`: 总集数
- `play_time`: 播放进度（秒）
- `total_time`: 总时长（秒）
- `save_time`: 保存时间戳（毫秒）
- `search_title`: 搜索标题（用于模糊搜索）

### 3. 收藏表 (favorites)

```sql
CREATE TABLE IF NOT EXISTS favorites (
  username TEXT NOT NULL,
  key TEXT NOT NULL, -- format: "source+id"
  source_name TEXT NOT NULL,
  total_episodes INTEGER NOT NULL,
  title TEXT NOT NULL,
  year TEXT,
  cover TEXT,
  save_time INTEGER NOT NULL,
  search_title TEXT,
  origin TEXT CHECK(origin IN ('vod', 'live')),
  is_completed INTEGER DEFAULT 0,
  vod_remarks TEXT,
  PRIMARY KEY (username, key),
  FOREIGN KEY (username) REFERENCES users(username) ON DELETE CASCADE
);

-- 收藏索引
CREATE INDEX IF NOT EXISTS idx_favorites_save_time ON favorites(username, save_time DESC);
CREATE INDEX IF NOT EXISTS idx_favorites_source ON favorites(username, source_name);
```

**字段说明：**
- `username`: 用户名，外键
- `key`: 视频唯一标识
- `source_name`: 来源名称
- `total_episodes`: 总集数
- `title`: 视频标题
- `year`: 发行年份
- `cover`: 封面图 URL
- `save_time`: 保存时间戳
- `search_title`: 搜索标题
- `origin`: 来源类型（vod/live）
- `is_completed`: 是否完结
- `vod_remarks`: 备注信息

### 4. 搜索历史表 (search_history)

```sql
CREATE TABLE IF NOT EXISTS search_history (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  username TEXT NOT NULL,
  keyword TEXT NOT NULL,
  timestamp INTEGER NOT NULL,
  FOREIGN KEY (username) REFERENCES users(username) ON DELETE CASCADE,
  UNIQUE(username, keyword)
);

-- 搜索历史索引
CREATE INDEX IF NOT EXISTS idx_search_history_user_time ON search_history(username, timestamp DESC);
```

**字段说明：**
- `id`: 自增 ID
- `username`: 用户名，外键
- `keyword`: 搜索关键词
- `timestamp`: 搜索时间戳

### 5. 跳过配置表 (skip_configs)

```sql
CREATE TABLE IF NOT EXISTS skip_configs (
  username TEXT NOT NULL,
  key TEXT NOT NULL, -- format: "source+id"
  enable INTEGER NOT NULL DEFAULT 1,
  intro_time INTEGER NOT NULL DEFAULT 0, -- 片头时长（秒）
  outro_time INTEGER NOT NULL DEFAULT 0, -- 片尾时长（秒）
  PRIMARY KEY (username, key),
  FOREIGN KEY (username) REFERENCES users(username) ON DELETE CASCADE
);

-- 跳过配置索引
CREATE INDEX IF NOT EXISTS idx_skip_configs_username ON skip_configs(username);
```

**字段说明：**
- `username`: 用户名，外键
- `key`: 视频唯一标识，格式为 "source+id"
- `enable`: 是否启用跳过
- `intro_time`: 片头跳过时长（秒）
- ` outro_time`: 片尾跳过时长（秒）

### 6. 弹幕过滤配置表 (danmaku_filter_configs)

```sql
CREATE TABLE IF NOT EXISTS danmaku_filter_configs (
  username TEXT PRIMARY KEY,
  rules TEXT NOT NULL, -- JSON array: [{"keyword": "xxx", "type": "normal", "enabled": true}]
  FOREIGN KEY (username) REFERENCES users(username) ON DELETE CASCADE
);
```

**字段说明：**
- `username`: 用户名，主键，外键
- `rules`: 过滤规则，JSON数组格式

### 7. 通知表 (notifications)

```sql
CREATE TABLE IF NOT EXISTS notifications (
  id TEXT PRIMARY KEY,
  username TEXT NOT NULL,
  type TEXT NOT NULL CHECK(type IN ('favorite_update', 'system', 'announcement', 'movie_request', 'request_fulfilled')),
  title TEXT NOT NULL,
  message TEXT NOT NULL,
  timestamp INTEGER NOT NULL,
  read INTEGER DEFAULT 0,
  metadata TEXT, -- JSON object
  FOREIGN KEY (username) REFERENCES users(username) ON DELETE CASCADE
);

-- 通知索引
CREATE INDEX IF NOT EXISTS idx_notifications_user_time ON notifications(username, timestamp DESC);
CREATE INDEX IF NOT EXISTS idx_notifications_user_read ON notifications(username, read, timestamp DESC);
```

**字段说明：**
- `id`: 通知 ID，主键
- `username`: 用户名，外键
- `type`: 通知类型
- `title`: 通知标题
- `message`: 通知内容
- `timestamp`: 时间戳
- `read`: 是否已读
- `metadata`: 附加数据，JSON 对象

### 8. 求片请求表 (movie_requests)

```sql
CREATE TABLE IF NOT EXISTS movie_requests (
  id TEXT PRIMARY KEY,
  tmdb_id INTEGER,
  title TEXT NOT NULL,
  year TEXT,
  media_type TEXT NOT NULL CHECK(media_type IN ('movie', 'tv')),
  season INTEGER,
  poster TEXT,
  overview TEXT,
  requested_by TEXT NOT NULL, -- JSON array: ["user1", "user2"]
  request_count INTEGER NOT NULL DEFAULT 1,
  status TEXT NOT NULL CHECK(status IN ('pending', 'fulfilled')) DEFAULT 'pending',
  created_at INTEGER NOT NULL,
  updated_at INTEGER NOT NULL,
  fulfilled_at INTEGER,
  fulfilled_source TEXT,
  fulfilled_id TEXT
);

-- 求片请求索引
CREATE INDEX IF NOT EXISTS idx_movie_requests_status ON movie_requests(status, created_at DESC);
CREATE INDEX IF NOT EXISTS idx_movie_requests_tmdb ON movie_requests(tmdb_id) WHERE tmdb_id IS NOT NULL;
```

**字段说明：**
- `id`: 请求 ID，主键
- `tmdb_id`: TMDB ID
- `title`: 影视标题
- `year`: 发行年份
- `media_type`: 媒体类型（movie/tv）
- `season`: 季数
- `poster`: 海报 URL
- `overview`: 简介
- `requested_by`: 请求者，JSON 数组
- `request_count`: 请求数量
- `status`: 状态（pending/fulfilled）
- `created_at`: 创建时间
- `updated_at`: 更新时间
- `fulfilled_at`: 完成时间
- `fulfilled_source`: 完成来源
- `fulfilled_id`: 完成 ID

### 9. 用户求片关联表 (user_movie_requests)

```sql
CREATE TABLE IF NOT EXISTS user_movie_requests (
  username TEXT NOT NULL,
  request_id TEXT NOT NULL,
  PRIMARY KEY (username, request_id),
  FOREIGN KEY (username) REFERENCES users(username) ON DELETE CASCADE,
  FOREIGN KEY (request_id) REFERENCES movie_requests(id) ON DELETE CASCADE
);

-- 用户求片索引
CREATE INDEX IF NOT EXISTS idx_user_movie_requests_user ON user_movie_requests(username);
```

**字段说明：**
- `username`: 用户名，外键
- `request_id`: 求片请求 ID，外键

### 10. 全局配置表 (global_config)

```sql
CREATE TABLE IF NOT EXISTS global_config (
  key TEXT PRIMARY KEY,
  value TEXT NOT NULL,
  updated_at INTEGER NOT NULL
);

-- 全局配置索引
CREATE INDEX IF NOT EXISTS idx_global_config_key ON global_config(key);
```

**字段说明：**
- `key`: 配置键，主键
- `value`: 配置值
- `updated_at`: 更新时间

### 11. 管理员配置表 (admin_config)

```sql
CREATE TABLE IF NOT EXISTS admin_config (
  id INTEGER PRIMARY KEY CHECK(id = 1), -- 确保只有一条记录
  config TEXT NOT NULL, -- JSON object
  updated_at INTEGER NOT NULL
);
```

**字段说明：**
- `id`: 固定为 1，确保单例
- `config`: 管理员配置，JSON 对象
- `updated_at`: 更新时间

### 12. 收藏更新检查时间表 (favorite_check_times)

```sql
CREATE TABLE IF NOT EXISTS favorite_check_times (
  username TEXT PRIMARY KEY,
  last_check_time INTEGER NOT NULL,
  FOREIGN KEY (username) REFERENCES users(username) ON DELETE CASCADE
);
```

**字段说明：**
- `username`: 用户名，主键，外键
- `last_check_time`: 最后检查时间

## 音乐模块表结构

### 13. 音乐播放记录表 (music_play_records)

```sql
CREATE TABLE IF NOT EXISTS music_play_records (
  username TEXT NOT NULL,
  key TEXT NOT NULL, -- format: "platform+id" (e.g., "netease+12345")
  platform TEXT NOT NULL CHECK(platform IN ('netease', 'qq', 'kuwo')), -- 音乐平台
  song_id TEXT NOT NULL, -- 歌曲ID
  name TEXT NOT NULL, -- 歌曲名
  artist TEXT NOT NULL, -- 艺术家
  album TEXT, -- 专辑（可选）
  pic TEXT, -- 封面图URL（可选）
  play_time REAL NOT NULL DEFAULT 0, -- 播放进度（秒）
  duration REAL NOT NULL DEFAULT 0, -- 总时长（秒）
  save_time INTEGER NOT NULL, -- 保存时间戳
  PRIMARY KEY (username, key),
  FOREIGN KEY (username) REFERENCES users(username) ON DELETE CASCADE
);

-- 音乐播放记录索引
CREATE INDEX IF NOT EXISTS idx_music_play_records_username ON music_play_records(username);
CREATE INDEX IF NOT EXISTS idx_music_play_records_save_time ON music_play_records(username, save_time DESC);
CREATE INDEX IF NOT EXISTS idx_music_play_records_platform ON music_play_records(username, platform);
```

**字段说明：**
- `username`: 用户名，外键
- `key`: 记录唯一标识，格式为 "platform+id"
- `platform`: 音乐平台（netease/qq/kuwo）
- `song_id`: 歌曲 ID
- `name`: 歌曲名
- `artist`: 艺术家
- `album`: 专辑
- `pic`: 封面图 URL
- `play_time`: 播放进度（秒）
- `duration`: 总时长（秒）
- `save_time`: 保存时间戳

### 14. 音乐歌单表 (music_playlists)

```sql
CREATE TABLE IF NOT EXISTS music_playlists (
  id TEXT NOT NULL, -- 歌单ID (UUID)
  username TEXT NOT NULL, -- 用户名
  name TEXT NOT NULL, -- 歌单名称
  description TEXT, -- 歌单描述（可选）
  cover TEXT, -- 歌单封面（可选，使用第一首歌的封面）
  created_at INTEGER NOT NULL, -- 创建时间戳
  updated_at INTEGER NOT NULL, -- 更新时间戳
  PRIMARY KEY (id),
  FOREIGN KEY (username) REFERENCES users(username) ON DELETE CASCADE
);

-- 音乐歌单索引
CREATE INDEX IF NOT EXISTS idx_music_playlists_username ON music_playlists(username, created_at DESC);
```

**字段说明：**
- `id`: 歌单 ID，UUID 格式，主键
- `username`: 用户名，外键
- `name`: 歌单名称
- `description`: 歌单描述
- `cover`: 歌单封面
- `created_at`: 创建时间戳
- `updated_at`: 更新时间戳

### 15. 音乐歌单歌曲关联表 (music_playlist_songs)

```sql
CREATE TABLE IF NOT EXISTS music_playlist_songs (
  playlist_id TEXT NOT NULL, -- 歌单ID
  platform TEXT NOT NULL CHECK(platform IN ('netease', 'qq', 'kuwo')), -- 音乐平台
  song_id TEXT NOT NULL, -- 歌曲ID
  name TEXT NOT NULL, -- 歌曲名
  artist TEXT NOT NULL, -- 艺术家
  album TEXT, -- 专辑（可选）
  pic TEXT, -- 封面图URL（可选）
  duration REAL NOT NULL DEFAULT 0, -- 总时长（秒）
  added_at INTEGER NOT NULL, -- 添加时间戳
  sort_order INTEGER NOT NULL DEFAULT 0, -- 排序顺序
  PRIMARY KEY (playlist_id, platform, song_id),
  FOREIGN KEY (playlist_id) REFERENCES music_playlists(id) ON DELETE CASCADE
);

-- 音乐歌单歌曲索引
CREATE INDEX IF NOT EXISTS idx_music_playlist_songs_playlist ON music_playlist_songs(playlist_id, sort_order ASC);
CREATE INDEX IF NOT EXISTS idx_music_playlist_songs_added_at ON music_playlist_songs(playlist_id, added_at DESC);
```

**字段说明：**
- `playlist_id`: 歌单 ID，外键
- `platform`: 音乐平台
- `song_id`: 歌曲 ID
- `name`: 歌曲名
- `artist`: 艺术家
- `album`: 专辑
- `pic`: 封面图 URL
- `duration`: 时长（秒）
- `added_at`: 添加时间戳
- `sort_order`: 排序顺序

## 常见操作示例

### 查询用户的所有播放记录
```sql
SELECT * FROM play_records WHERE username = 'your_username' ORDER BY save_time DESC LIMIT 20;
```

### 查询用户的收藏列表
```sql
SELECT * FROM favorites WHERE username = 'your_username' ORDER BY save_time DESC;
```

### 查询用户的搜索历史
```sql
SELECT * FROM search_history WHERE username = 'your_username' ORDER BY timestamp DESC LIMIT 10;
```

### 查询用户的跳过配置
```sql
SELECT * FROM skip_configs WHERE username = 'your_username';
```

### 查询所有待处理的求片请求
```sql
SELECT * FROM movie_requests WHERE status = 'pending' ORDER BY created_at DESC;
```

### 查询用户的所有通知
```sql
SELECT * FROM notifications WHERE username = 'your_username' ORDER BY timestamp DESC LIMIT 50;
```

### 查询用户的音乐播放记录
```sql
SELECT * FROM music_play_records WHERE username = 'your_username' ORDER BY save_time DESC;
```

### 查询用户的音乐歌单
```sql
SELECT * FROM music_playlists WHERE username = 'your_username' ORDER BY created_at DESC;
```

### 查询歌单中的歌曲
```sql
SELECT * FROM music_playlist_songs WHERE playlist_id = 'playlist_id' ORDER BY sort_order ASC;
```

### 统计用户播放记录数量
```sql
SELECT COUNT(*) as total FROM play_records WHERE username = 'your_username';
```

### 统计用户收藏数量
```sql
SELECT COUNT(*) as total FROM favorites WHERE username = 'your_username';
```

### 清理旧的搜索历史（保留最近100条）
```sql
DELETE FROM search_history
WHERE username = 'your_username'
  AND id NOT IN (
    SELECT id FROM search_history
    WHERE username = 'your_username'
    ORDER BY timestamp DESC
    LIMIT 100
  );
```

## 备份与恢复

### 备份数据库
```bash
wrangler d1 backup moontv-plus-db
```

### 恢复数据库
```bash
wrangler d1 restore moontv-plus-db <backup-file-path>
```

## 监控与调试

### 查看数据库大小
```bash
wrangler d1 info moontv-plus-db
```

### 执行 SQL 查询进行调试
```bash
wrangler d1 execute moontv-plus-db --command="SELECT * FROM users LIMIT 10;" --remote
```

## 注意事项

1. **外键约束**：所有用户相关表都设置了 `ON DELETE CASCADE`，删除用户时会自动删除相关数据
2. **时间戳格式**：所有时间戳均为毫秒级整数（JavaScript `Date.now()` 格式）
3. **JSON 字段**：tags、enabled_apis、requested_by 等字段存储为 JSON 字符串
4. **唯一约束**：注意各表的 UNIQUE 和 PRIMARY KEY 约束
5. **索引优化**：已为常用查询创建适当索引

## 故障排除

### 数据库连接失败
- 检查 `wrangler.toml` 中的 `database_id` 是否正确
- 确保已登录 Cloudflare：`wrangler login`
- 检查 D1 数据库是否在正确区域

### 迁移失败
- 确保迁移文件路径正确
- 检查 SQL 语法是否兼容 SQLite（D1 基于 SQLite）
- 查看错误日志获取详细信息

### 数据查询异常
- 确认字段名拼写正确
- 检查数据类型是否匹配
- 验证外键约束是否满足

## 相关资源

- [Cloudflare D1 文档](https://developers.cloudflare.com/d1/)
- [SQLite 语法参考](https://www.sqlite.org/lang.html)
- [Wrangler CLI 参考](https://developers.cloudflare.com/workers/wrangler/)
- [项目迁移文件](migrations/)
