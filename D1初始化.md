<<<<<<< HEAD
# Cloudflare D1 数据库初始化

MoonTV Plus 项目使用 Cloudflare D1 作为生产环境数据库。

## 快速初始化（全新部署）

### 1. 设置环境变量

在 Cloudflare Pages → Settings → Environment variables 中设置：

| 变量名 | 值 |
|--------|-----|
| `NEXT_PUBLIC_STORAGE_TYPE` | `d1` |
| `USERNAME` | `admin` |
| `PASSWORD` | `**********` |

### 2. 初始化数据库表结构

```bash
npx wrangler d1 execute mdhfuep --file=sql/init_complete.sql --remote
```

### 3. 创建站长用户

```bash
npx wrangler d1 execute mdhfuep --file=init_owner_correct.sql --remote
```

### 4. 验证初始化结果

```bash
npx wrangler d1 execute mdhfuep --command="SELECT '用户数:' as label, COUNT(*) as count FROM users UNION ALL SELECT '收藏表:', COUNT(*) FROM favorites;" --remote
```

预期输出：
```
label: 用户数, count: 1
label: 收藏表, count: 0
```

## 数据库文件

| 文件 | 用途 |
|------|------|
| `sql/init_complete.sql` | 完整初始化脚本（15个表 + 索引 + 初始数据） |
| `init_owner_correct.sql` | 创建站长用户 |

## 表结构（15个表）

| 序号 | 表名 | 说明 |
|------|------|------|
| 1 | `users` | 用户表 |
| 2 | `play_records` | 播放记录 |
| 3 | `favorites` | 收藏 |
| 4 | `search_history` | 搜索历史 |
| 5 | `skip_configs` | 跳过配置 |
| 6 | `danmaku_filter_configs` | 弹幕过滤 |
| 7 | `notifications` | 通知 |
| 8 | `movie_requests` | 求片请求 |
| 9 | `user_movie_requests` | 用户求片关联 |
| 10 | `global_config` | 全局配置 |
| 11 | `admin_config` | 管理员配置 |
| 12 | `favorite_check_times` | 收藏检查时间 |
| 13 | `music_play_records` | 音乐播放记录 |
| 14 | `music_playlists` | 音乐歌单 |
| 15 | `music_playlist_songs` | 歌单歌曲 |

## 常用查询

```bash
# 查看所有表
npx wrangler d1 execute mdhfuep --command="SELECT name FROM sqlite_master WHERE type='table' ORDER BY name;" --remote

# 查看用户
SELECT username, role, banned FROM users;

# 查看收藏
SELECT * FROM favorites WHERE username='lizhi123le';

# 删除用户（级联删除所有数据）
DELETE FROM users WHERE username='username';

# 清空收藏
DELETE FROM favorites;
```

## 故障排除

### "数据库操作失败" 错误

1. 检查 `users` 表是否为空
2. 执行 `sql/init_complete.sql` 初始化表结构
3. 执行 `init_owner_correct.sql` 创建站长

### 收藏功能失败

可能是 `favorites` 表缺少字段，执行初始化脚本修复：
```bash
npx wrangler d1 execute mdhfuep --file=sql/init_complete.sql --remote
```

## 相关资源

- [Cloudflare D1 文档](https://developers.cloudflare.com/d1/)
- [Wrangler CLI 命令](https://developers.cloudflare.com/workers/wrangler/)

=======
# Cloudflare D1 数据库初始化

MoonTV Plus 项目使用 Cloudflare D1 作为生产环境数据库。

## 快速初始化（全新部署）

### 1. 设置环境变量

在 Cloudflare Pages → Settings → Environment variables 中设置：

| 变量名 | 值 |
|--------|-----|
| `NEXT_PUBLIC_STORAGE_TYPE` | `d1` |
| `USERNAME` | `admin` |
| `PASSWORD` | `*******` |

### 2. 初始化数据库表结构

```bash
npx wrangler d1 execute mdhfuep --file=sql/init_complete.sql --remote
```

### 3. 创建站长用户

```bash
npx wrangler d1 execute mdhfuep --file=init_owner_correct.sql --remote
```

### 4. 验证初始化结果

```bash
npx wrangler d1 execute mdhfuep --command="SELECT '用户数:' as label, COUNT(*) as count FROM users UNION ALL SELECT '收藏表:', COUNT(*) FROM favorites;" --remote
```

预期输出：
```
label: 用户数, count: 1
label: 收藏表, count: 0
```

## 数据库文件

| 文件 | 用途 |
|------|------|
| `sql/init_complete.sql` | 完整初始化脚本（15个表 + 索引 + 初始数据） |
| `init_owner_correct.sql` | 创建站长用户 |

## 表结构（15个表）

| 序号 | 表名 | 说明 |
|------|------|------|
| 1 | `users` | 用户表 |
| 2 | `play_records` | 播放记录 |
| 3 | `favorites` | 收藏 |
| 4 | `search_history` | 搜索历史 |
| 5 | `skip_configs` | 跳过配置 |
| 6 | `danmaku_filter_configs` | 弹幕过滤 |
| 7 | `notifications` | 通知 |
| 8 | `movie_requests` | 求片请求 |
| 9 | `user_movie_requests` | 用户求片关联 |
| 10 | `global_config` | 全局配置 |
| 11 | `admin_config` | 管理员配置 |
| 12 | `favorite_check_times` | 收藏检查时间 |
| 13 | `music_play_records` | 音乐播放记录 |
| 14 | `music_playlists` | 音乐歌单 |
| 15 | `music_playlist_songs` | 歌单歌曲 |

## 常用查询

```bash
# 查看所有表
npx wrangler d1 execute mdhfuep --command="SELECT name FROM sqlite_master WHERE type='table' ORDER BY name;" --remote

# 查看用户
SELECT username, role, banned FROM users;

# 查看收藏
SELECT * FROM favorites WHERE username='lizhi123le';

# 删除用户（级联删除所有数据）
DELETE FROM users WHERE username='username';

# 清空收藏
DELETE FROM favorites;
```

## 故障排除

### "数据库操作失败" 错误

1. 检查 `users` 表是否为空
2. 执行 `sql/init_complete.sql` 初始化表结构
3. 执行 `init_owner_correct.sql` 创建站长

### 收藏功能失败

可能是 `favorites` 表缺少字段，执行初始化脚本修复：
```bash
npx wrangler d1 execute mdhfuep --file=sql/init_complete.sql --remote
```

## 相关资源

- [Cloudflare D1 文档](https://developers.cloudflare.com/d1/)
- [Wrangler CLI 命令](https://developers.cloudflare.com/workers/wrangler/)
=======
# Cloudflare D1 数据库初始化

MoonTV Plus 项目使用 Cloudflare D1 作为生产环境数据库。

## 快速初始化（全新部署）

### 1. 设置环境变量

在 Cloudflare Pages → Settings → Environment variables 中设置：

| 变量名 | 值 |
|--------|-----|
| `NEXT_PUBLIC_STORAGE_TYPE` | `d1` |
| `USERNAME` | `admin` |
| `PASSWORD` | `**********` |

### 2. 初始化数据库表结构

```bash
npx wrangler d1 execute mdhfuep --file=sql/init_complete.sql --remote
```

### 3. 创建站长用户

```bash
npx wrangler d1 execute mdhfuep --file=init_owner_correct.sql --remote
```

### 4. 验证初始化结果

```bash
npx wrangler d1 execute mdhfuep --command="SELECT '用户数:' as label, COUNT(*) as count FROM users UNION ALL SELECT '收藏表:', COUNT(*) FROM favorites;" --remote
```

预期输出：
```
label: 用户数, count: 1
label: 收藏表, count: 0
```

## 数据库文件

| 文件 | 用途 |
|------|------|
| `sql/init_complete.sql` | 完整初始化脚本（15个表 + 索引 + 初始数据） |
| `init_owner_correct.sql` | 创建站长用户 |

## 表结构（15个表）

| 序号 | 表名 | 说明 |
|------|------|------|
| 1 | `users` | 用户表 |
| 2 | `play_records` | 播放记录 |
| 3 | `favorites` | 收藏 |
| 4 | `search_history` | 搜索历史 |
| 5 | `skip_configs` | 跳过配置 |
| 6 | `danmaku_filter_configs` | 弹幕过滤 |
| 7 | `notifications` | 通知 |
| 8 | `movie_requests` | 求片请求 |
| 9 | `user_movie_requests` | 用户求片关联 |
| 10 | `global_config` | 全局配置 |
| 11 | `admin_config` | 管理员配置 |
| 12 | `favorite_check_times` | 收藏检查时间 |
| 13 | `music_play_records` | 音乐播放记录 |
| 14 | `music_playlists` | 音乐歌单 |
| 15 | `music_playlist_songs` | 歌单歌曲 |

## 常用查询

```bash
# 查看所有表
npx wrangler d1 execute mdhfuep --command="SELECT name FROM sqlite_master WHERE type='table' ORDER BY name;" --remote

# 查看用户
SELECT username, role, banned FROM users;

# 查看收藏
SELECT * FROM favorites WHERE username='lizhi123le';

# 删除用户（级联删除所有数据）
DELETE FROM users WHERE username='username';

# 清空收藏
DELETE FROM favorites;
```

## 故障排除

### "数据库操作失败" 错误

1. 检查 `users` 表是否为空
2. 执行 `sql/init_complete.sql` 初始化表结构
3. 执行 `init_owner_correct.sql` 创建站长

### 收藏功能失败

可能是 `favorites` 表缺少字段，执行初始化脚本修复：
```bash
npx wrangler d1 execute mdhfuep --file=sql/init_complete.sql --remote
```

## 相关资源

- [Cloudflare D1 文档](https://developers.cloudflare.com/d1/)
- [Wrangler CLI 命令](https://developers.cloudflare.com/workers/wrangler/)
=======
# Cloudflare D1 数据库初始化

MoonTV Plus 项目使用 Cloudflare D1 作为生产环境数据库。

## 快速初始化（全新部署）

### 1. 设置环境变量

在 Cloudflare Pages → Settings → Environment variables 中设置：

| 变量名 | 值 |
|--------|-----|
| `NEXT_PUBLIC_STORAGE_TYPE` | `d1` |
| `USERNAME` | `admin` |
| `PASSWORD` | `*******` |

### 2. 初始化数据库表结构

```bash
npx wrangler d1 execute mdhfuep --file=sql/init_complete.sql --remote
```

### 3. 创建站长用户

```bash
npx wrangler d1 execute mdhfuep --file=init_owner_correct.sql --remote
```

### 4. 验证初始化结果

```bash
npx wrangler d1 execute mdhfuep --command="SELECT '用户数:' as label, COUNT(*) as count FROM users UNION ALL SELECT '收藏表:', COUNT(*) FROM favorites;" --remote
```

预期输出：
```
label: 用户数, count: 1
label: 收藏表, count: 0
```

## 数据库文件

| 文件 | 用途 |
|------|------|
| `sql/init_complete.sql` | 完整初始化脚本（15个表 + 索引 + 初始数据） |
| `init_owner_correct.sql` | 创建站长用户 |

## 表结构（15个表）

| 序号 | 表名 | 说明 |
|------|------|------|
| 1 | `users` | 用户表 |
| 2 | `play_records` | 播放记录 |
| 3 | `favorites` | 收藏 |
| 4 | `search_history` | 搜索历史 |
| 5 | `skip_configs` | 跳过配置 |
| 6 | `danmaku_filter_configs` | 弹幕过滤 |
| 7 | `notifications` | 通知 |
| 8 | `movie_requests` | 求片请求 |
| 9 | `user_movie_requests` | 用户求片关联 |
| 10 | `global_config` | 全局配置 |
| 11 | `admin_config` | 管理员配置 |
| 12 | `favorite_check_times` | 收藏检查时间 |
| 13 | `music_play_records` | 音乐播放记录 |
| 14 | `music_playlists` | 音乐歌单 |
| 15 | `music_playlist_songs` | 歌单歌曲 |

## 常用查询

```bash
# 查看所有表
npx wrangler d1 execute mdhfuep --command="SELECT name FROM sqlite_master WHERE type='table' ORDER BY name;" --remote

# 查看用户
SELECT username, role, banned FROM users;

# 查看收藏
SELECT * FROM favorites WHERE username='lizhi123le';

# 删除用户（级联删除所有数据）
DELETE FROM users WHERE username='username';

# 清空收藏
DELETE FROM favorites;
```

## 故障排除

### "数据库操作失败" 错误

1. 检查 `users` 表是否为空
2. 执行 `sql/init_complete.sql` 初始化表结构
3. 执行 `init_owner_correct.sql` 创建站长

### 收藏功能失败

可能是 `favorites` 表缺少字段，执行初始化脚本修复：
```bash
npx wrangler d1 execute mdhfuep --file=sql/init_complete.sql --remote
```

## 相关资源

- [Cloudflare D1 文档](https://developers.cloudflare.com/d1/)
- [Wrangler CLI 命令](https://developers.cloudflare.com/workers/wrangler/)
>>>>>>> 9cf1c9f (fix: add D1_DATABASE_ID environment variable to cloudflare deploy workflow)
